<!DOCTYPE html>
<html>
<head>
    <title>Teacher Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark app-nav-blur">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">üë®‚Äçüè´ Teacher Dashboard - Welcome, {{ teacher_name }}!</span>
            <div>
                <span class="text-white me-3">Active Students: {{ student_stats|length }}</span>
                <a href="/teacher/logout" class="btn btn-outline-light">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-2 sidebar">
                <div class="p-3 text-center">
                    <h5 class="text-white">Teacher Panel</h5>
                </div>
                <div class="list-unstyled">
                    <li><a href="#students" class="active">üìä Student Management</a></li>
                    <li><a href="/teacher/exam_results">üìà Exam Results</a></li>
                    <li><a href="/teacher/create_exam">‚ûï Create Exam</a></li>
                    <li><a href="#cheating-alerts">‚ö†Ô∏è Cheating Alerts</a></li>
                    <li><a href="#camera-logs">üì∑ Camera Proctoring</a></li>
                </div>
            </div>

            <div class="col-md-10 content">
                <!-- Statistics Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card stat-card bg-primary text-white shadow-soft">
                            <div class="card-body text-center py-4">
                                <h3>{{ student_stats|length }}</h3>
                                <p class="mb-0">Total Students</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card bg-success text-white shadow-soft">
                            <div class="card-body text-center py-4">
                                <h3>{{ student_stats|selectattr('submitted_attempts', 'gt', 0)|list|length }}</h3>
                                <p class="mb-0">Active Students</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card bg-warning text-white shadow-soft">
                            <div class="card-body text-center py-4">
                                <h3>{{ student_stats|sum(attribute='cheating_events') }}</h3>
                                <p class="mb-0">Cheating Events</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card bg-danger text-white shadow-soft">
                            <div class="card-body text-center py-4">
                                <h3>{{ student_stats|sum(attribute='terminated_exams') }}</h3>
                                <p class="mb-0">Terminated Exams</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Camera Proctoring Overview -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow-soft">
                            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">üìä Camera Proctoring Overview</h5>
                                <span class="badge bg-light text-dark">Live Monitoring</span>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-md-3">
                                        <div class="border rounded p-3">
                                            <h4 class="text-primary">{{ camera_stats.total_sessions }}</h4>
                                            <p class="mb-0">Active Camera Sessions</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="border rounded p-3">
                                            <h4 class="text-warning">{{ camera_stats.total_warnings }}</h4>
                                            <p class="mb-0">Camera Warnings Today</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="border rounded p-3">
                                            <h4 class="text-success">{{ camera_stats.clean_sessions }}</h4>
                                            <p class="mb-0">Clean Sessions</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="border rounded p-3">
                                            <h4 class="text-danger">{{ camera_stats.terminated_by_camera }}</h4>
                                            <p class="mb-0">Terminated by Camera</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Students Table -->
                <div id="students" class="card mb-4 shadow-soft">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">üéì Student Management ({{ student_stats|length }} Students)</h5>
                        <button class="btn btn-sm btn-light" onclick="refreshData()">üîÑ Refresh</button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Roll No.</th>
                                        <th>Name</th>
                                        <th>Tests Attended</th>
                                        <th>Cheating Events</th>
                                        <th>Camera Warnings</th>
                                        <th>Terminated Exams</th>
                                        <th>Integrity Score</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for student in student_stats %}
                                    <tr>
                                        <td><strong>{{ student.roll_number }}</strong></td>
                                        <td>{{ student.name }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if student.submitted_attempts > 0 else 'secondary' }}">
                                                {{ student.submitted_attempts }}/{{ student.total_attempts }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'danger' if student.cheating_events > 0 else 'success' }}">
                                                {{ student.cheating_events }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'warning' if student.camera_warnings > 0 else 'success' }}">
                                                {{ student.camera_warnings }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'danger' if student.terminated_exams > 0 else 'success' }}">
                                                {{ student.terminated_exams }}
                                            </span>
                                        </td>
                                        <td>
                                            {% set integrity_score = 100 - (student.cheating_events * 10) - (student.camera_warnings * 5) %}
                                            {% set integrity_score = max(0, integrity_score) %}
                                            <div class="progress" style="height: 8px;">
                                                <div class="progress-bar bg-{{ 'success' if integrity_score >= 80 else 'warning' if integrity_score >= 60 else 'danger' }}" 
                                                     style="width: {{ integrity_score }}%"></div>
                                            </div>
                                            <small>{{ integrity_score }}%</small>
                                        </td>
                                        <td>
                                            <a href="/teacher/student_details/{{ student.id }}" class="btn btn-sm btn-outline-primary">
                                                View Details
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Camera Proctoring Logs -->
                <div id="camera-logs" class="card mb-4 shadow-soft">
                    <div class="card-header bg-warning text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">üì∑ Real-time Camera Proctoring Logs</h5>
                        <span class="badge bg-light text-dark">{{ recent_camera_logs|length }} Events</span>
                    </div>
                    <div class="card-body">
                        {% if recent_camera_logs %}
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Student</th>
                                            <th>Exam</th>
                                            <th>Event Type</th>
                                            <th>Confidence</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for log in recent_camera_logs %}
                                        <tr class="{{ 'cheating-warning' if log.CameraLog.event_type in ['multiple_faces_detected', 'no_face_detected'] }}">
                                            <td>
                                                <small>{{ log.CameraLog.timestamp.strftime('%H:%M') }}</small><br>
                                                <small class="text-muted">{{ log.CameraLog.timestamp.strftime('%m/%d') }}</small>
                                            </td>
                                            <td>
                                                <strong>{{ log.User.username }}</strong><br>
                                                <small class="text-muted">{{ log.User.full_name }}</small>
                                            </td>
                                            <td>Exam {{ log.CameraLog.exam_id }}</td>
                                            <td>
                                                <span class="badge bg-{{ 
                                                    'danger' if log.CameraLog.event_type in ['multiple_faces_detected', 'no_face_detected'] 
                                                    else 'warning' if log.CameraLog.event_type in ['face_too_small', 'face_not_centered'] 
                                                    else 'info' 
                                                }}">
                                                    {{ log.CameraLog.event_type|replace('_', ' ')|title }}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="progress" style="height: 6px; width: 60px;">
                                                    <div class="progress-bar bg-{{ 'success' if log.CameraLog.confidence < 0.5 else 'warning' if log.CameraLog.confidence < 0.8 else 'danger' }}" 
                                                         style="width: {{ log.CameraLog.confidence * 100 }}%"></div>
                                                </div>
                                                <small>{{ "%.0f"|format(log.CameraLog.confidence * 100) }}%</small>
                                            </td>
                                            <td>
                                                {% if log.ExamAttempt.terminated %}
                                                <span class="badge bg-danger">Terminated</span>
                                                {% else %}
                                                <span class="badge bg-{{ 'warning' if log.ExamAttempt.cheating_count > 0 else 'success' }}">
                                                    {{ log.ExamAttempt.cheating_count }} Warnings
                                                </span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="text-center py-4">
                                <div class="text-muted">
                                    <h5>No camera proctoring events yet</h5>
                                    <p>Camera monitoring logs will appear here when students start taking exams</p>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Cheating Alerts -->
                <div id="cheating-alerts" class="card shadow-soft">
                    <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">‚ö†Ô∏è Recent Security Alerts</h5>
                        <span class="badge bg-light text-dark">{{ recent_cheating|length }} Alerts</span>
                    </div>
                    <div class="card-body">
                        {% if recent_cheating %}
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>Student</th>
                                            <th>Exam</th>
                                            <th>Alert Type</th>
                                            <th>Time</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for cheat in recent_cheating %}
                                        <tr class="table-warning">
                                            <td>
                                                <strong>{{ cheat.User.username }}</strong><br>
                                                <small class="text-muted">{{ cheat.User.full_name }}</small>
                                            </td>
                                            <td>Exam {{ cheat.CheatingLog.exam_id }}</td>
                                            <td>
                                                <span class="badge bg-warning">
                                                    {{ cheat.CheatingLog.cheat_type|replace('_', ' ')|title }}
                                                </span>
                                            </td>
                                            <td>{{ cheat.CheatingLog.timestamp.strftime('%H:%M %m/%d') }}</td>
                                            <td>
                                                {% if cheat.ExamAttempt.terminated %}
                                                <span class="badge bg-danger">Terminated</span>
                                                {% else %}
                                                <span class="badge bg-warning">Warning</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="text-muted text-center py-3">No recent security alerts. Good job!</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Real-time updates for cheating detection
        function startLiveUpdates() {
            setInterval(() => {
                fetch('/teacher/live_updates')
                    .then(response => response.json())
                    .then(data => {
                        if (data.new_cheating_events > 0 || data.new_camera_events > 0) {
                            showNotification(`New security events detected: ${data.new_cheating_events} cheating, ${data.new_camera_events} camera`);
                            setTimeout(() => {
                                refreshData();
                            }, 3000);
                        }
                    })
                    .catch(error => console.error('Live update error:', error));
            }, 5000);
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'alert alert-warning alert-dismissible fade show position-fixed';
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                <strong>‚ö†Ô∏è Live Alert!</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        function refreshData() {
            window.location.reload();
        }

        // Start live updates when page loads
        document.addEventListener('DOMContentLoaded', function() {
            startLiveUpdates();
            console.log('Live monitoring started for teacher dashboard');
        });

        // Auto-refresh every 30 seconds if there are active alerts
        setInterval(() => {
            const activeSessions = document.querySelectorAll('.cheating-warning').length;
            if (activeSessions > 0) {
                refreshData();
            }
        }, 30000);
    </script>
</body>
</html>